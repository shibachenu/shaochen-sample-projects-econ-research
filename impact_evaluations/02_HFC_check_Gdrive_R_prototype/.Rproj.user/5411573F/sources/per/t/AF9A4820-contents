#Automatically export excel spreadsheet to Google drive, notice this code cannot be run standalone, it is integrated with the overall PSSN-HFC check

#example of running this in Stata is
#shell "$rpath" --vanilla  <"$rwd"/HFC_export_G_drive.R --args hfcoutput="$hfcoutput"

#If googledrive is not installed, install locally, otherwise load the library
if (!require("googledrive")) install.packages("googledrive")
library(googledrive)

#The following line authenticate the Google account access via a browser, only needed for the first time
drive_auth()

#Setup folders for renewed uploads of HFC results
endline_folder_name = "PSSN2 Endline"
endline_folder = drive_mkdir(endline_folder_name, path = "~", overwrite = TRUE)
endline_folder_path = paste("~", endline_folder_name, sep = "/")  
  
endline_flagged_folder_name = "Flagged_Cases"
endline_flagged_folder = drive_mkdir(endline_flagged_folder_name, path = endline_folder_path, overwrite = TRUE)
endline_flagged_folder_path = paste(endline_folder_path, endline_flagged_folder_name, sep = "/") 
  
hfc_arg = commandArgs(trailingOnly = TRUE)
hfc_output = strsplit(hfc_arg, "=", fixed = TRUE)[[1]][2]

pssn2_endline_hfc_filename = "PSSN2_Endline_HFCs.xlsx"
hfc_output_file =  file.path(hfc_output, pssn2_endline_hfc_filename)
print(hfc_output_file)

pssn2_endline_flagged_cases_filename = "PSSN2_Endline_Flagged_Cases.xlsx"
hfc_output_flagged =  file.path(hfc_output, pssn2_endline_flagged_cases_filename)
print(hfc_output_flagged)

pssn_hfcs = drive_put(hfc_output_file, path = endline_folder_path, name = pssn2_endline_hfc_filename)
pssn_flagged = drive_put(hfc_output_flagged, path = endline_flagged_folder_path, name = pssn2_endline_flagged_cases_filename)

#Permission control: share these files with writer permission with users needed
#shared_email = "daisyc.reboul@gmail.com"
shared_email = "ifwonderland@gmail.com"

pssn_hfcs %>%
drive_share(
  role = "writer",
  type = "user",
  emailAddress = shared_email,
  emailMessage = "PSSN 2 HFC results spreadsheet for collaboration"
)

pssn_flagged %>%
  drive_share(
    role = "writer",
    type = "user",
    emailAddress = shared_email,
    emailMessage = "PSSN 2 HFC Flagged cases spreadsheet for collaboration"
  )


#Download this file back to the local folder
drive_download(pssn_flagged, path = file.path(hfc_output, "Downloaded_Endline_Flagged.xlsx"), overwrite = TRUE)